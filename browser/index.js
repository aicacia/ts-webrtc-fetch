import{bytesToInteger as e,integerToBytes as t}from"https://unpkg.com/@aicacia/hash@0/browser/index.js";import{MAX_INT as r}from"https://unpkg.com/@aicacia/rand@0/browser/index.js";const n="HTTP-WEBRTC/1.0",a="\r".charCodeAt(0),s="\n".charCodeAt(0);function o(e,t,r){return c(t,e.encode(r))}function c(e,t){const r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}function d(){return Math.random()*r|0}function u(r){const u=new Map,i=new TextEncoder,l=new TextDecoder;function w(e,t,r){let n=d();for(;u.has(n);)n=d();const a=function(e,t,r,n){const a=new TransformStream,s={connectionId:e,url:new URL(t.url),handled:!1,readStatus:!1,readHeaders:!1,headers:new Headers,status:200,statusText:"",stream:a,writer:a.writable.getWriter(),handle(e,t){s.handled?n(new TypeError("Response already handled")):(s.handled=!0,e?n(e):t?r(t):n(new TypeError("No response")))}};return s.timeoutId=setTimeout((()=>s.handle(new TypeError("Request timed out"))),6e4),s}(n,e,t,r);return u.set(n,a),a}async function h(e,t){const r=u.get(e);if(r)if(r.readStatus)if(r.readHeaders)await r.writer.ready,t[0]===a&&t[1]===s?(u.delete(e),clearTimeout(r.timeoutId),r.timeoutId=void 0,await r.writer.close()):await r.writer.write(t);else if(t[0]===a&&t[1]===s)r.readHeaders=!0,r.handle(void 0,function(e){const t=new Response(e.stream.readable,{status:e.status,statusText:e.statusText,headers:e.headers,duplex:"half"});return Object.defineProperty(t,"url",{value:`webrtc-http:${e.url.pathname}${e.url.search}`}),t}(r));else{const[e,n]=l.decode(t).split(/\:\s+/);r.headers.append(e,n)}else{r.readStatus=!0;const[e,n,a]=l.decode(t).split(/\s+/,3);r.status=Number.parseInt(n),r.statusText=a}}async function m(t){const r=new Uint8Array(t.data),n=e(r);await h(n,r.slice(4))}function p(e,a){return new Promise(((s,d)=>{const u=new Request(e,a);!async function(e,a){const s=new URL(a.url),d=t(new Uint8Array(4),e);if(r.send(o(i,d,`${a.method} ${s.pathname+s.search} ${n}`)),a.headers.forEach(((e,t)=>{r.send(o(i,d,`${t}: ${e}`))})),r.send(o(i,d,"\r\n")),a.body){const e=a.body.getReader();for(;;){const{done:t,value:n}=await e.read();if(n&&r.send(c(d,n)),t)break}}r.send(o(i,d,"\r\n"))}(w(u,s,d).connectionId,u)}))}return r.addEventListener("message",m),p.destroy=()=>r.removeEventListener("message",m),p}function i(r,d){const u=new Map,i=new TextEncoder,l=new TextDecoder;async function w(e,a){const s=await d(a);await async function(e,a){const s=t(new Uint8Array(4),e);if(r.send(o(i,s,`${n} ${a.status} ${function(e){switch(e){case 100:return"Continue";case 101:return"Switching Protocols";case 102:return"Processing";case 103:return"Early Hints";case 200:return"OK";case 201:return"Created";case 202:return"Accepted";case 203:return"Non-Authoritative Information";case 204:return"No Content";case 205:return"Reset Content";case 206:return"Partial Content";case 207:return"Multi-Status";case 208:return"Already Reported";case 226:return"IM Used";case 300:return"Multiple Choices";case 301:return"Moved Permanently";case 302:return"Found";case 303:return"See Other";case 304:return"Not Modified";case 305:return"Use Proxy";case 306:return"Switch Proxy";case 307:return"Temporary Redirect";case 308:return"Permanent Redirect";case 400:return"Bad Request";case 401:return"Unauthorized";case 402:return"Payment Required";case 403:return"Forbidden";case 404:return"Not Found";case 405:return"Method Not Allowed";case 406:return"Not Acceptable";case 407:return"Proxy Authentication Required";case 408:return"Request Timeout";case 409:return"Conflict";case 410:return"Gone";case 411:return"Length Required";case 412:return"Precondition Failed";case 413:return"Payload Too Large";case 414:return"URI Too Long";case 415:return"Unsupported Media Type";case 416:return"Range Not Satisfiable";case 417:return"Expectation Failed";case 418:return"I'm a teapot";case 421:return"Misdirected Request";case 422:return"Unprocessable Entity";case 423:return"Locked";case 424:return"Failed Dependency";case 425:return"Too Early";case 426:return"Upgrade Required";case 428:return"Precondition Required";case 429:return"Too Many Requests";case 431:return"Request Header Fields Too Large";case 451:return"Unavailable For Legal Reasons";case 500:return"Internal Server Error";case 501:return"Not Implemented";case 502:return"Bad Gateway";case 503:return"Service Unavailable";case 504:return"Gateway Timeout";case 505:return"HTTP Version Not Supported";case 506:return"Variant Also Negotiates";case 507:return"Insufficient Storage";case 508:return"Loop Detected";case 510:return"Not Extended";case 511:return"Network Authentication Required";default:return"Unknown Status Code"}}(a.status)}`)),a.headers.forEach(((e,t)=>{r.send(o(i,s,`${t}: ${e}`))})),r.send(o(i,s,"\r\n")),a.body){const e=a.body.getReader();for(;;){const{done:t,value:n}=await e.read();if(n&&r.send(c(s,n)),t)break}}r.send(o(i,s,"\r\n"))}(e,s)}async function h(e,t){const r=u.get(e);if(r)if(r.readHeaders)await r.writer.ready,t[0]===a&&t[1]===s?(u.delete(e),clearTimeout(r.timeoutId),r.timeoutId=void 0,await r.writer.close()):await r.writer.write(t);else if(t[0]===a&&t[1]===s)r.readHeaders=!0,await w(e,(n=r,new Request(`webrtc-http:${n.path}`,{method:n.method,headers:n.headers,body:"GET"===n.method||"HEAD"===n.method?null:n.stream.readable,duplex:"half"})));else{const[e,n]=l.decode(t).split(/\:\s+/,2);r.headers.append(e,n)}else{const[r,n,a]=l.decode(t).split(/\s+/);if(r&&n&&a){const t=function(e,t){const r=new TransformStream;return{readHeaders:!1,method:e,path:t,headers:new Headers,stream:r,writer:r.writable.getWriter()}}(r,n);u.set(e,t),t.timeoutId=setTimeout((()=>u.delete(e)),6e4)}}var n}async function m(t){const r=new Uint8Array(t.data),n=e(r);await h(n,r.slice(4))}return r.addEventListener("message",m),()=>{r.removeEventListener("message",m)}}export{u as createWebRTCFetch,i as createWebRTCServer};
//# sourceMappingURL=index.js.map
