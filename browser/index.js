import"https://unpkg.com/tslib@2/tslib.es6.js";function e(e,t){return e[0]=(4278190080&t)>>24,e[1]=(16711680&t)>>16,e[2]=(65280&t)>>8,e[3]=255&t,e}function t(e){return e[3]|e[2]<<8|e[1]<<16|e[0]<<24}const r=Math.pow(2,31)-1|0,n={},s={};class i{constructor(e,t){if(e!==n)throw new TypeError("Options can only be created with the some or none functions");this._value=t}static some(e){return u(e)}static none(){return a()}static from(e){return null!=e?u(e):a()}static fromJSON(e){return i.from(e)}isNone(){return this._value===s}isSome(){return!this.isNone()}expect(e){if(this.isSome())return this._value;throw new Error("function"==typeof e?e():e)}unwrap(){return this.expect("Tried to unwrap value of none Option")}unwrapOr(e){return this.isSome()?this._value:e}unwrapOrElse(e){return this.isSome()?this._value:e()}map(e){return this.isSome()?u(e(this._value)):a()}mapOr(e,t){return this.isSome()?u(e(this._value)):u(t)}mapOrElse(e,t){return this.isSome()?u(e(this._value)):u(t())}flatMap(e){return this.isSome()?e(this._value):a()}flatMapOr(e,t){return this.isSome()?e(this._value):t}flatMapOrElse(e,t){return this.isSome()?e(this._value):t()}and(e){return this.isSome()?e:a()}andThen(e){return this.isSome()?e(this._value):a()}or(e){return this.isNone()?e:this}orElse(e){return this.isNone()?e():this}xor(e){const t=this.isSome(),r=e.isSome();return t&&!r?this:!t&&r?e:a()}filter(e){return this.isSome()&&e(this._value)?this:a()}getOrInsert(e){return this.isNone()&&(this._value=e),this}getOrInsertWith(e){return this.isNone()&&(this._value=e()),this}clear(){return this._value=s,this}take(){if(this.isSome()){const e=this._value;return this._value=s,u(e)}return a()}from(e){return null!=e?this._value=e:this.clear(),this}replace(e){return this._value=e,this}ifSome(e,t){return this.isSome()?e(this._value):t&&t(),this}ifNone(e,t){return this.isNone()?e():t&&t(this._value),this}toJSON(){return this.unwrapOr(null)}toJS(){return this.unwrapOr(null)}[Symbol.iterator](){return new o(this._value)}}class o{constructor(e){this.value=e}next(){if(this.value===s)return{done:!0,value:void 0};{const e=this.value;return this.value=s,{done:!1,value:e}}}}const u=e=>new i(n,e),a=()=>new i(n,s);class h{constructor(e){this._index=0,this._iter=e}[Symbol.iterator](){return this}iter(){return this}next(){return this._iter.next()}nextWithIndex(){const e=this._iter.next();return e.done?e:{value:[e.value,this._index++]}}enumerate(){throw new Error("Enumerate was not imported!")}peekable(){throw new Error("Peekable was not imported!")}forEach(e){throw new Error("ForEach was not imported!")}map(e){throw new Error("Map was not imported!")}merge(e){throw new Error("Merge was not imported!")}concat(e){return this.merge(e)}filter(e){throw new Error("Filter was not imported!")}step(e){throw new Error("Step was not imported!")}skip(e){throw new Error("Skip was not imported!")}take(e){throw new Error("Take was not imported!")}toMap(e,t){throw new Error("ToMap was not imported!")}flatten(e){throw new Error("Flatten was not imported!")}unflatten(e){throw new Error("Unflatten was not imported!")}reverse(){throw new Error("Reverse was not imported!")}count(){return this.reduce(0,(e=>e+1))}consume(){let e=this.next();for(;!e.done;)e=this.next();return this}toArray(){return this.reduce([],((e,t)=>(e.push(t),e)))}join(e){return this.toArray().join(e)}indexOf(e){let t=this.next(),r=0;for(;!t.done;){if(t.value===e)return r;r++,t=this.next()}return-1}findIndex(e){let t=this.nextWithIndex();for(;!t.done;){const[r,n]=t.value;if(e(r,n))return n;t=this.nextWithIndex()}return-1}find(e){let t=this.nextWithIndex();for(;!t.done;){const[r,n]=t.value;if(e(r,n))return u(r);t=this.nextWithIndex()}return a()}findAll(e){return this.filter(e)}nth(e=0){let t=this.next();for(e<0&&(e=0);!t.done;){if(e--<=0)return u(t.value);t=this.next()}return a()}first(){return this.nth(0)}last(){let e=this.next();for(;!e.done;){const t=this.next();if(t.done)return u(e.value);e=t}return a()}any(e){return-1!==this.findIndex(e)}some(e){return this.any(e)}none(e){return-1===this.findIndex(e)}all(e){let t=this.nextWithIndex();for(;!t.done;){const[r,n]=t.value;if(!e(r,n))return!1;t=this.nextWithIndex()}return!0}reduce(e,t){let r=this.next();for(;!r.done;){e=t(e,r.value,this._index-1),r=this.next()}return e}}function c(e){return null!=e?"function"==typeof e[Symbol.iterator]?new h(e[Symbol.iterator]()):"function"==typeof e.next?e instanceof h?e:new h(e):c("object"==typeof e?Object.entries(e):[e]):c([])}class d extends h{constructor(e){super(e)}next(){const e=super.nextWithIndex();return e.done?e:{value:l(e.value)}}}function l(e){const t=e[0],r=e;return r[0]=e[1],r[1]=t,r}h.prototype.enumerate=function(){return new d(this)};const p=e=>e,f=e=>e;class x extends h{constructor(e,t=p,r=f){super(e),this._map=([e,n])=>[t(e,n),r(e,n)]}toObject(){return this.reduce({},((e,t)=>(e[t[0]]=t[1],e)))}next(){const e=super.nextWithIndex();return e.done?e:{done:!1,value:this._map(e.value)}}}h.prototype.toMap=function(e,t){return new x(this,e,t)};class w extends h{constructor(e,t){super(e),this._fn=t}next(){let e=super.nextWithIndex();for(;!e.done;){const[t,r]=e.value;if(this._fn(t,r))return{done:!1,value:t};e=super.nextWithIndex()}return{done:!0,value:void 0}}}h.prototype.filter=function(e){return new w(this,e)};class m extends h{constructor(e,t){super(e),this._fn=([e,r])=>(t(e,r),e)}next(){const e=super.nextWithIndex();return e.done?e:{done:!1,value:this._fn(e.value)}}}h.prototype.forEach=function(e){return new m(this,e)};class v extends h{constructor(e,t){super(e),this._fn=t}next(){const e=super.nextWithIndex();if(e.done)return e;{const[t,r]=e.value;return{done:!1,value:this._fn(t,r)}}}}h.prototype.map=function(e){return new v(this,e)};class y extends h{constructor(e,t){super(e),this._other=t}next(){const e=super.next();return e.done?this._other.next():e}}h.prototype.merge=function(e){return new y(this,e)};class _ extends h{constructor(){super(...arguments),this.peeked=[]}unpeekAll(){return this.peeked.length=0,this}unpeek(){return this.peeked.length>0?u(this.peeked.shift()):a()}peek(e=0){if(e<this.peeked.length)return u(this.peeked[e]);{let t=this.peeked.length-e-1,r=super.next();for(;!(r.done||(this.peeked.push(r.value),--t<=0));)r=super.next();return r.done?a():u(r.value)}}next(){const e=this.unpeek();if(e.isSome())return{done:!1,value:e.unwrap()};const t=super.next();return t.done?t:{done:!1,value:t.value}}}h.prototype.peekable=function(){return new _(this)};class I extends h{constructor(e){super(e),this.index=0,this.reversed=!1,this.values=[]}next(){if(!this.reversed){let e=super.next();for(;!e.done;)this.values.push(e),e=super.next();this.reversed=!0,this.index=this.values.length}return 0===this.index?{done:!0,value:void 0}:(this.index-=1,this.values[this.index])}}h.prototype.reverse=function(){return new I(this)};class g extends h{constructor(e,t){super(e),this._skipped=0,this._skip=0|(t<=0?0:t)}next(){let e=super.next();for(;!e.done;){if(!(this._skipped<=this._skip))return e;this._skipped+=1,e=super.next()}return{done:!0,value:void 0}}}h.prototype.skip=function(e){return new g(this,e)};class S extends h{constructor(e,t){super(e),this._stepped=0,this._step=t<=0?1:0|t}next(){let e=super.next();for(;!e.done;){if(!(this._stepped<this._step))return this._stepped=0,e;this._stepped+=1,e=super.next()}return{done:!0,value:void 0}}}h.prototype.step=function(e){return new S(this,e)};class E extends h{constructor(e,t){super(e),this._taken=0,this._count=0|(t<=0?0:t)}next(){return this._taken<this._count?(this._taken+=1,super.next()):{done:!0,value:void 0}}}h.prototype.take=function(e){return new E(this,e)};class R extends h{constructor(e,t){super(e),this._fn=t}next(){return this._fn(this._iter)}}h.prototype.unflatten=function(e){return new R(this,e)};class b extends h{constructor(e,t=1){super(e),this._current=void 0,this._depth=t}next(){if(void 0!==this._current){const e=this._current.next();if(!e.done)return e;this._current=void 0}return this._nextRecur()}_nextRecur(){const e=super.next();if(e.done)return e;if(this._depth>0){const t=c(e.value).flatten(this._depth-1),r=t.next();return r.done?this._nextRecur():(this._current=t,r)}return e}}h.prototype.flatten=function(e=1){return new b(this,e)};class k extends h{constructor(e){super(e),this.rng=e}iter(){return new h(this)}next(){return{done:!1,value:this.rng.nextFloat()}}}class T extends h{constructor(e,t=0,r=1){super(e),this.rng=e,this.min=t,this.max=r}iter(){return new h(this)}nextFloat(){return this.rng.nextFloatInRange(this.min,this.max)}next(){return{done:!1,value:this.nextFloat()}}}class A extends h{constructor(e,t=0,n=r){super(e),this.rng=e,this.min=0|t,this.max=0|n}iter(){return new h(this)}nextInt(){return this.rng.nextIntInRange(this.min,this.max)}next(){return{done:!1,value:this.nextInt()}}}const O=new Uint8Array(4);class M{nextFloat(){return this.nextInt()/r}nextFloatInRange(e=0,t=1){return e+this.nextFloat()*(t-e)}nextIntInRange(e=0,t=r){return Math.round(this.nextFloatInRange(e,t))}shuffle(e){const t=e.length;for(let r=0;r<t;r++){const n=r+this.nextIntInRange(0,t-r-1),s=e[r];e[r]=e[n],e[n]=s}return e}fromArray(e){return e.length?u(e[this.nextIntInRange(0,e.length-1)]):a()}keyFromObject(e){return this.fromArray(Object.keys(e))}valueFromObject(e){return this.fromArray(Object.values(e))}fillBytes(t){const r=O;for(let n=0,s=t.length;n<s;n++){const s=n%4;0===s&&e(r,this.nextInt()),t[n]=r[s]}return t}[Symbol.iterator](){return this}iter(){return new h(this)}next(){return{done:!1,value:this.nextInt()}}float(){return new k(this)}uniformFloat(e=0,t=1){return new T(this,e,t)}uniformInt(e=0,t=r){return new A(this,e,t)}}class N extends M{constructor(e=423257940){super(),this.seed=e}setSeed(e=423257940){return this.seed=e,this}nextInt(){return this.seed=Math.imul(48271,this.seed)|0%r,this.seed&r}}const F=new N;class U extends M{constructor(e,t,r,n){super(),this.x=423257940,this.y=2829571177,this.z=2541948421,this.w=289122235,this.set(e,t,r,n)}static fromSeed(e){return(new U).setSeed(e)}setSeed(e){const t=F.setSeed(e);return this.set(t.nextInt(),t.nextInt(),t.nextInt(),t.nextInt())}set(e=423257940,t=2829571177,r=2541948421,n=289122235){return this.x=0|e,this.y=0|t,this.z=0|r,this.w=0|n,this}nextInt(){const e=this.x,t=e^e<<11;this.x=this.y,this.y=this.z,this.z=this.w;const r=this.w;return this.w=r^r>>19^t^t>>8,this.w}}new N,new U;const P="HTTP-WEBRTC/1.0",W="\r".charCodeAt(0),q="\n".charCodeAt(0);function H(e,t,r){return L(t,e.encode(r))}function L(e,t){const r=new Uint8Array(e.length+t.length);return r.set(e),r.set(t,e.length),r}function $(){return Math.random()*r|0}function j(r){const n=new Map,s=new TextEncoder,i=new TextDecoder;function o(e,t,r){let s=$();for(;n.has(s);)s=$();const i=function(e,t,r,n){const s=new TransformStream,i={connectionId:e,url:new URL(t.url),handled:!1,readStatus:!1,readHeaders:!1,headers:new Headers,status:200,statusText:"",stream:s,writer:s.writable.getWriter(),handle(e,t){i.handled?n(new TypeError("Response already handled")):(i.handled=!0,e?n(e):t?r(t):n(new TypeError("No response")))}};return i.timeoutId=setTimeout((()=>i.handle(new TypeError("Request timed out"))),6e4),i}(s,e,t,r);return n.set(s,i),i}async function u(e,t){const r=n.get(e);if(r)if(r.readStatus)if(r.readHeaders)await r.writer.ready,t[0]===W&&t[1]===q?(n.delete(e),clearTimeout(r.timeoutId),r.timeoutId=void 0,await r.writer.close()):await r.writer.write(t);else if(t[0]===W&&t[1]===q)r.readHeaders=!0,r.handle(void 0,function(e){const t=new Response(e.stream.readable,{status:e.status,statusText:e.statusText,headers:e.headers,duplex:"half"});return Object.defineProperty(t,"url",{value:`webrtc-http:${e.url.pathname}${e.url.search}`}),t}(r));else{const[e,n]=i.decode(t).split(/\:\s+/);r.headers.append(e,n)}else{r.readStatus=!0;const[e,n,s]=i.decode(t).split(/\s+/,3);r.status=parseInt(n),r.statusText=s}}async function a(e){const r=new Uint8Array(e.data),n=t(r);await u(n,r.slice(4))}function h(t,n){return new Promise((async(i,u)=>{const a=new Request(t,n),h=o(a,i,u);await async function(t,n){const i=new URL(n.url),o=e(new Uint8Array(4),t);if(r.send(H(s,o,`${n.method} ${i.pathname+i.search} ${P}`)),n.headers.forEach(((e,t)=>{r.send(H(s,o,`${t}: ${e}`))})),r.send(H(s,o,"\r\n")),n.body){const e=n.body.getReader();for(;;){const{done:t,value:n}=await e.read();if(n&&r.send(L(o,n)),t)break}}r.send(H(s,o,"\r\n"))}(h.connectionId,a)}))}return r.addEventListener("message",a),h.destroy=()=>r.removeEventListener("message",a),h}function C(r,n){const s=new Map,i=new TextEncoder,o=new TextDecoder;async function u(t,s){const o=await n(s);await async function(t,n){const s=e(new Uint8Array(4),t);if(r.send(H(i,s,`${P} ${n.status} ${function(e){switch(e){case 100:return"Continue";case 101:return"Switching Protocols";case 102:return"Processing";case 103:return"Early Hints";case 200:return"OK";case 201:return"Created";case 202:return"Accepted";case 203:return"Non-Authoritative Information";case 204:return"No Content";case 205:return"Reset Content";case 206:return"Partial Content";case 207:return"Multi-Status";case 208:return"Already Reported";case 226:return"IM Used";case 300:return"Multiple Choices";case 301:return"Moved Permanently";case 302:return"Found";case 303:return"See Other";case 304:return"Not Modified";case 305:return"Use Proxy";case 306:return"Switch Proxy";case 307:return"Temporary Redirect";case 308:return"Permanent Redirect";case 400:return"Bad Request";case 401:return"Unauthorized";case 402:return"Payment Required";case 403:return"Forbidden";case 404:return"Not Found";case 405:return"Method Not Allowed";case 406:return"Not Acceptable";case 407:return"Proxy Authentication Required";case 408:return"Request Timeout";case 409:return"Conflict";case 410:return"Gone";case 411:return"Length Required";case 412:return"Precondition Failed";case 413:return"Payload Too Large";case 414:return"URI Too Long";case 415:return"Unsupported Media Type";case 416:return"Range Not Satisfiable";case 417:return"Expectation Failed";case 418:return"I'm a teapot";case 421:return"Misdirected Request";case 422:return"Unprocessable Entity";case 423:return"Locked";case 424:return"Failed Dependency";case 425:return"Too Early";case 426:return"Upgrade Required";case 428:return"Precondition Required";case 429:return"Too Many Requests";case 431:return"Request Header Fields Too Large";case 451:return"Unavailable For Legal Reasons";case 500:return"Internal Server Error";case 501:return"Not Implemented";case 502:return"Bad Gateway";case 503:return"Service Unavailable";case 504:return"Gateway Timeout";case 505:return"HTTP Version Not Supported";case 506:return"Variant Also Negotiates";case 507:return"Insufficient Storage";case 508:return"Loop Detected";case 510:return"Not Extended";case 511:return"Network Authentication Required";default:return"Unknown Status Code"}}(n.status)}`)),n.headers.forEach(((e,t)=>{r.send(H(i,s,`${t}: ${e}`))})),r.send(H(i,s,"\r\n")),n.body){const e=n.body.getReader();for(;;){const{done:t,value:n}=await e.read();if(n&&r.send(L(s,n)),t)break}}r.send(H(i,s,"\r\n"))}(t,o)}async function a(e,t){const r=s.get(e);if(r)if(r.readHeaders)await r.writer.ready,t[0]===W&&t[1]===q?(s.delete(e),clearTimeout(r.timeoutId),r.timeoutId=void 0,await r.writer.close()):await r.writer.write(t);else if(t[0]===W&&t[1]===q)r.readHeaders=!0,await u(e,(n=r,new Request(`webrtc-http:${n.path}`,{method:n.method,headers:n.headers,body:"GET"===n.method||"HEAD"===n.method?null:n.stream.readable,duplex:"half"})));else{const[e,n]=o.decode(t).split(/\:\s+/,2);r.headers.append(e,n)}else{const[r,n,i]=o.decode(t).split(/\s+/);if(r&&n&&i){const t=function(e,t){const r=new TransformStream;return{readHeaders:!1,method:e,path:t,headers:new Headers,stream:r,writer:r.writable.getWriter()}}(r,n);s.set(e,t),t.timeoutId=setTimeout((()=>s.delete(e)),6e4)}}var n}async function h(e){const r=new Uint8Array(e.data),n=t(r);await a(n,r.slice(4))}return r.addEventListener("message",h),()=>{r.removeEventListener("message",h)}}export{j as createWebRTCFetch,C as createWebRTCServer};
//# sourceMappingURL=index.js.map
